<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posts &middot; urandom</title>

    <meta name="description" content="">

    <meta name="generator" content="Hugo 0.40.1" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Posts &middot; urandom">
    <meta name="twitter:description" content="">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Posts &middot; urandom">
    <meta property="og:description" content="">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="//blog.urandom.team/css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="urandom" href="//blog.urandom.team/index.xml" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="//blog.urandom.team">urandom</a></h1>
            <h2 class="brand-tagline"></h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                
                <li class="nav-item">
                    <a class="pure-button" href="//blog.urandom.team/index.xml"><i class="fa fa-rss"></i> rss</a>
                </li>
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                <h1 class="content-subhead">29 Dec 2019, 21:54</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="//blog.urandom.team/post/tracing-securerom-malloc-free/" class="post-title">SecureROMのmalloc/free追跡</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">op</strong>
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h1 id="概要">概要</h1>

<p>axi0mX氏のcheckm8公開により、広く一般にSecureROM(iPhone/iPadのブートローダー)の動的解析が可能になった。SecureROMのヒープレイアウトへの理解を深める為にヒープ関連処理を解析し、その一環としてSecureROM開始時からDFUモード起動完了までの間に発生するmalloc/freeの呼び出しをデバッガーで追跡したので、研究用として記事に残す。</p>

<p>C97でもこの記事のコピ本を頒布予定(火曜日 南地区 リ-04b)で、間に合えば細かい話を加筆する。</p>

<h1 id="関連記事">関連記事</h1>

<p>checkm8の解説ではa1exdandy氏による次の記事が非常によくまとまっている。</p>

<p><a href="https://habr.com/en/company/dsec/blog/472762/">Technical analysis of the checkm8 exploit</a></p>

<p>上の記事でもヒープの確保シーケンスについて静的解析に基づいた解説があるが、この記事の動的解析でも上の記事と近い結果が得られた。</p>

<h1 id="検証環境">検証環境</h1>

<ul>
<li>iPhone 7 (A1779)</li>
<li>Bonobo JTAG/SWD Debug Cable</li>
<li>ipwndfu

<ul>
<li>Matthew Pierson氏によるfork版</li>
<li>commit bb3c1d618f96ce96956089823f396b777b4c46acに一部変更を加えたもの</li>
</ul></li>
</ul>

<h1 id="調査手順">調査手順</h1>

<p>checkm8(ipwndfu)を使用してiPhone 7(ターゲット)からSecureROMを読み出しGhidraで解析した。解析によりいわゆるmalloc, free, memalignと思われる3関数のアドレスを特定した。</p>

<p>ipwndfuを使用してターゲットのSWDを有効化(demote)し、Bonobo JTAG/SWD Debug Cableを使用してgdbでターゲットにアタッチした。</p>

<p>SecureROM開始直後から実行を追跡するにはターゲットをリセットする必要があるが、通常の手順でターゲットをリセットすると、リセットによりdemotionの状態が初期化されてSWDが無効になり追跡できなくなる。このため、今回はdemote後にターゲットをreset vectorへジャンプさせてもう一度最初から起動処理を行わせて追跡した。Reset vectorへのジャンプ前に予めmalloc, free, memalignへハードウェアブレークポイントを張っておいて、それぞれへの呼び出しを監視・記録した。</p>

<h1 id="追跡結果">追跡結果</h1>

<h2 id="備考">備考</h2>

<p>この章では、iPhone 7の実機から読みだした情報を引用する。この章で引用するメモリダンプのベースはDFUモード起動完了直後のもので、ベースは0x180000000である。</p>

<h2 id="一覧">一覧</h2>

<p>次の書式でalloc, free, memalignの呼び出しの遷移を記す。</p>

<p>呼び出し元アドレス : 関数名(引数) =&gt; 返り値</p>

<pre><code>000000010000f858 : free(0x00000001801b4080)
000000010000edd0 : alloc(48)                    =&gt; 0x00000001801b4080
000000010000ede0 : alloc(256)                   =&gt; 0x00000001801b4100
0000000100011548 : alloc(4000)                  =&gt; 0x00000001801b4240
00000001000115d0 : free(0x00000001801b4240)
000000010000f124 : alloc(512)                   =&gt; 0x00000001801b4240
000000010000d10c : alloc(234)                   =&gt; 0x00000001801b4480
000000010000d10c : alloc(22)                    =&gt; 0x00000001801b45c0
000000010000d10c : alloc(62)                    =&gt; 0x00000001801b4640
000000010000d10c : alloc(198)                   =&gt; 0x00000001801b46c0
000000010000d10c : alloc(62)                    =&gt; 0x00000001801b4800
000000010000a9e0 : alloc(960)                   =&gt; 0x00000001801b4880
000000010000a9f0 : alloc(16384)                 =&gt; 0x00000001801b4c80
000000010000df08 : memalign(2048, 0x00000040)   =&gt; 0x00000001801b8d00
000000010000d2a4 : alloc(25)                    =&gt; 0x00000001801b9540
000000010000d2b4 : alloc(25)                    =&gt; 0x00000001801b95c0
</code></pre>

<h2 id="メモ">メモ</h2>

<h3 id="000000010000f858-free-0x00000001801b4080">000000010000f858 : free(0x00000001801b4080)</h3>

<p>このfreeは不要領域の解放のためではなく、ヒープの初期化時に使用可能な領域をリストに登録するためのもの。</p>

<p>ヒープのベースは0x1801b4000で、空ブロック1つ(長さ0x40)と、追加しようとしているブロック自身のメタデータ(長さ0x40)が先行して配置されるため、ベース + 0x80が追加する領域の（データ部分の）オフセットになる。空ブロックは後方にも配置される。</p>

<h3 id="000000010000edd0-alloc-48-0x00000001801b4080">000000010000edd0 : alloc(48)                    =&gt; 0x00000001801b4080</h3>

<p>役割不明のバッファー。</p>

<h3 id="000000010000ede0-alloc-256-0x00000001801b4100">000000010000ede0 : alloc(256)                   =&gt; 0x00000001801b4100</h3>

<p>役割不明のバッファー。</p>

<h3 id="0000000100011548-alloc-4000-0x00000001801b4240">0000000100011548 : alloc(4000)                  =&gt; 0x00000001801b4240</h3>

<p>役割不明のバッファー。</p>

<h3 id="00000001000115d0-free-0x00000001801b4240">00000001000115d0 : free(0x00000001801b4240)</h3>

<p>直前で確保した長さ4000のバッファーを解放。</p>

<h3 id="000000010000f124-alloc-512-0x00000001801b4240">000000010000f124 : alloc(512)                   =&gt; 0x00000001801b4240</h3>

<p>役割不明のバッファー。</p>

<p>メモリの内容を確認すると、先頭に”host bridge”とのASCII文字列が書き込まれている。</p>

<pre><code>001b4240  68 6f 73 74 20 62 72 69  64 67 65 00 00 00 00 00  |host bridge.....|
001b4250  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
001b4310  0c 16 00 00 01 00 00 00  6c 16 00 00 01 00 00 00  |........l.......|
001b4320  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 c0  |................|
001b4330  00 00 00 02 00 00 00 00  00 00 00 00 00 00 00 00  |................|
001b4340  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
001b4440
</code></pre>

<h3 id="000000010000d10c-alloc-234-0x00000001801b4480">000000010000d10c : alloc(234)                   =&gt; 0x00000001801b4480</h3>

<p>USBのString Descriptor (Descriptor Index = 1)</p>

<p>ApNonceとSEPNonceをHostに通知するためのもの。ASCII文字による16進表記かつ1文字あたり2バイトで表現するのでApNonceとSEPNonceの情報量に比してサイズが大きい。</p>

<p>これ以降の追跡結果はa1exdandy氏の記事の解析結果と概ね一致する。</p>

<h3 id="000000010000d10c-alloc-22-0x00000001801b45c0">000000010000d10c : alloc(22)                    =&gt; 0x00000001801b45c0</h3>

<p>USBのString Descriptor (Manufacturer)</p>

<h3 id="000000010000d10c-alloc-62-0x00000001801b4640">000000010000d10c : alloc(62)                    =&gt; 0x00000001801b4640</h3>

<p>USBのString Descriptor (Product)</p>

<h3 id="000000010000d10c-alloc-198-0x00000001801b46c0">000000010000d10c : alloc(198)                   =&gt; 0x00000001801b46c0</h3>

<p>USBのString Descriptor (Serial Number)</p>

<p>DFUモードではここにハードウェアとソフトウェアのバージョンや設定情報を詰め込むので長い。</p>

<h3 id="000000010000d10c-alloc-62-0x00000001801b4800">000000010000d10c : alloc(62)                    =&gt; 0x00000001801b4800</h3>

<p>USBのString Descriptor (Configuration)</p>

<h3 id="000000010000a9e0-alloc-960-0x00000001801b4880">000000010000a9e0 : alloc(960)                   =&gt; 0x00000001801b4880</h3>

<p>USBコントローラーを制御するタスクのタスク構造体。</p>

<h3 id="000000010000a9f0-alloc-16384-0x00000001801b4c80">000000010000a9f0 : alloc(16384)                 =&gt; 0x00000001801b4c80</h3>

<p>USBコントローラーを制御するタスクのタスクスタック。</p>

<p>ここの確保サイズはa1exdandy氏の記事と異なる。a1exdandy氏の記事では確保サイズが0x1000となっているのに対して、今回実機で確認できた確保サイズは0x4000(16384)だった。呼び出し箇所の周辺を調べるとmax(0x1000, 0x4000)の比較結果を確保サイズとしていた。</p>

<h3 id="000000010000df08-memalign-2048-0x00000040-0x00000001801b8d00">000000010000df08 : memalign(2048, 0x00000040)   =&gt; 0x00000001801b8d00</h3>

<p>USBの入出力用バッファー。</p>

<h3 id="000000010000d2a4-alloc-25-0x00000001801b9540">000000010000d2a4 : alloc(25)                    =&gt; 0x00000001801b9540</h3>

<p>USBのConfiguration Descriptor</p>

<p>a1exdandy氏の記事によればこちらがHigh-Speed用のdescriptorとのこと。書き込まれるデータは後述のFull-Speed用descriptorと同一。</p>

<p>ipwndfu/src/checkm8_arm64.S内のgUSBDescriptorsは、ここで確保されたバッファーへのポインターを指す。</p>

<pre><code>00088a30  40 95 1b 80 01 00 00 00  c0 95 1b 80 01 00 00 00  |@...............|
</code></pre>

<h3 id="000000010000d2b4-alloc-25-0x00000001801b95c0">000000010000d2b4 : alloc(25)                    =&gt; 0x00000001801b95c0</h3>

<p>USBのConfiguration Descriptor</p>

<p>a1exdandy氏の記事によればこちらがFull-Speed用のdescriptorとのこと。</p>

<h1 id="備考-1">備考</h1>

<p>今回はreset vectorにジャンプすることでwarm reset(的な操作)を施してSecureROMを開始直後から追跡したが、warm reset時の状態は通常起動時と異なるため、通常起動時と挙動が一致するかどうかは不明。ただし、warm reset後でもcheckm8が成功することは確認できた。</p>

<h1 id="編集履歴">編集履歴</h1>

<h2 id="2019-12-31">2019/12/31</h2>

<p>USB関連の記述に誤りがあったため訂正した。</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">25 Dec 2018, 18:03</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="//blog.urandom.team/post/c95-announce/" class="post-title">C95参加と新刊のお知らせ</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">yyu</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Publication" href="//blog.urandom.team/categories/publication">Publication</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>C95（2018年冬コミ）に当選してました。
スペースは <strong>2日目 東6 ト44b</strong> です。
新刊“urandom vol.7”を出します。</p>

<p>次の画像をクリックすると本文サンプルが見えます。</p>

<p><a href="/pdfs/c95_sample.pdf"><img src="/images/c95_cover_thumb.jpg" alt="c95 sample" /></a></p>

<p>urandom vol.7は次の内容になります。</p>

<ul>
<li>SECCON2018 国際大会決勝参戦記 (by urandom)</li>
<li>展開署名: Folding Signatureの進捗 (by yyu)</li>
</ul>

<p>ページ数は本文30pとなっております。頒布価格は300円の予定です。</p>

<p>それでは会場でお会いしましょう。</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">05 Aug 2018, 22:13</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="//blog.urandom.team/post/c94-announce/" class="post-title">C94参加と新刊のお知らせ</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">yyu</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Publication" href="//blog.urandom.team/categories/publication">Publication</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>C94（2018年夏コミ）に当選してました。
スペースは <strong>1日目 西1 む39b</strong> です。
新刊“urandom vol.6”を出します。</p>

<p>次の画像をクリックすると本文サンプルが見えます。</p>

<p><a href="/pdfs/c94_sample.pdf"><img src="/images/c94_cover_thumb.png" alt="c94 sample" /></a></p>

<p>urandom vol.6は次の内容になります。</p>

<ul>
<li>IoT機器のFW解析 -CBCTF2018予選問題 Odin解説- (by op)</li>
<li>素因数分解ゲーム (by yyu)</li>
</ul>

<p>ページ数は本文34pとなっております。頒布価格は300円の予定です。</p>

<p>それでは会場でお会いしましょう。</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">25 Dec 2017, 18:40</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="//blog.urandom.team/post/c93-announce/" class="post-title">C93参加と新刊のお知らせ</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">yyu</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Publication" href="//blog.urandom.team/categories/publication">Publication</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>C93（2017年冬コミ）に当選してました。
スペースは <strong>1日目 東キ47a</strong> です<sup class="footnote-ref" id="fnref:change"><a href="#fn:change">1</a></sup>。
新刊“urandom vol.5”を出します。</p>

<p>次の画像をクリックすると本文サンプルが見えます。</p>

<p><a href="/pdfs/c93_sample.pdf"><img src="/images/c93_cover_thumb.png" alt="c94 sample" /></a></p>

<p>urandom vol.5は次のような内容になります。</p>

<ul>
<li>CBCTF2017問題解説 - One of Three Billion (by op)</li>
<li>Bitcoinによる公平なCTF (by yyu)</li>
</ul>

<p>ページ数は本文34pとなっております。頒布価格は300円の予定です。</p>

<p>それでは会場でお会いしましょう。</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:change">これまでは3日目でしたが、今回から1日目となりましたのでご注意ください。
 <a class="footnote-return" href="#fnref:change"><sup>[return]</sup></a></li>
</ol>
</div>

                    </div>
                </section>
                
                <h1 class="content-subhead">08 Aug 2017, 02:03</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="//blog.urandom.team/post/c92-announce/" class="post-title">C92参加と新刊のお知らせ</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">yyu</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Publication" href="//blog.urandom.team/categories/publication">Publication</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>C92（2017年夏コミ）に当選してました。
スペースは <strong>3日目 東イ-60b</strong> です。
新刊“urandom vol.4”と既刊“urandom vol.3”を出します。</p>

<p><a href="/pdfs/c92_sample.pdf"><img src="/images/c92_cover_thumb.png" alt="c92 sample" /></a></p>

<p>urandom vol.4は次のような内容になります。</p>

<ul>
<li>mitmproxy入門 (by op)</li>
<li>公平なランサムウェアプロトコル (by yyu)</li>
</ul>

<p>ページ数は本文34pとなっております。頒布価格は300円の予定です。</p>

<p>それでは会場でお会いしましょう。</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">28 Apr 2017, 21:15</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="//blog.urandom.team/post/cho-tech/" class="post-title">超技術書典参加のお知らせ</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">yyu</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Publication" href="//blog.urandom.team/categories/publication">Publication</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>ニコニコ超会議2017に併催の<a href="https://techbookfest.org/event/cho01">超技術書典</a>に当選しました。スペースは <strong>1日目 B-17</strong> です。
C91に引き続き、“<a href="/post/c91-digital/">urandom vol.3</a>”を頒布します。</p>

<ul>
<li><a href="https://techbookfest.org/event/cho01/circle/5671617594130432">https://techbookfest.org/event/cho01/circle/5671617594130432</a></li>
</ul>

<p>頒布価格は300円です。それでは会場でお会いしましょう。</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">12 Mar 2017, 17:17</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="//blog.urandom.team/post/c91-digital/" class="post-title">urandom vol.3電子版公開のお知らせ</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">yyu</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Publication" href="//blog.urandom.team/categories/publication">Publication</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h1 id="urandom-vol-3電子版">urandom vol.3電子版</h1>

<p><img src="/images/c91_cover.png" alt="C91 Sample" /></p>

<p>C91の1ヶ月後に出すと告知しておいて、結局3月になってしまいましたが、urandom vol.3の電子版を公開しました。</p>

<p>urandom vol.3電子版は <strong>128円</strong> での販売となります。内容は物理書籍版とほぼ同じです。</p>

<p>販売ページは<a href="https://gum.co/uqxsS">こちら（Gumroad）</a>です。決済にはクレジットカードかPayPalが使えます。</p>

<h2 id="物理書籍版購入者の方へ">物理書籍版購入者の方へ</h2>

<p>購入ページに“Offer code”という欄がありますので、そちらに物理書籍挟み込みの紙に記載されたコードを入力してください。</p>

<ul>
<li>コードを使用する場合、クレジットカード情報は不要です。正しいコードを入力すると入力欄が非表示になります。</li>
<li>同一コードは10回まで使用可能です。ダウンロードしたデータを紛失した際は同一コードを入力してください。</li>
</ul>

                    </div>
                </section>
                
                <h1 class="content-subhead">13 Dec 2016, 01:30</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="//blog.urandom.team/post/c91-sample/" class="post-title">C91 新刊のお知らせ</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mayth</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Publication" href="//blog.urandom.team/categories/publication">Publication</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><a href="/pdfs/c91_sample.pdf"><img src="/images/c91_cover.png" alt="C91 Sample" /></a></p>

<p>表紙だよ！　リンク先はサンプルのPDFだよ！（※サンプルにはカラー写真が含まれていますが、当日頒布する冊子はグレースケールです）</p>

<p>数多の困難を乗り越え、来るC91で頒布する新刊「urandom vol.3」の入稿が完了しました。</p>

<p>改めて告知しますと、スペースは <strong>土曜日 東R-12b</strong> です（<a href="https://webcatalog.circle.ms/Circle/13006119">Webカタログ</a>）。3日目だよ、大晦日だよ。</p>

<p>ページ数は本文64pと読みごたえ抜群の仕様となっております。頒布価格は300円です。</p>

<p>今回の記事は以下の3本です。</p>

<ul>
<li>ファミコンミニとLinux - op</li>
<li>Secure Grouping Protocol Using Mental Poker - yyu</li>
<li>urandom出版技術部活動報告 - mayth</li>
</ul>

<p>なお、今回<strong>既刊の頒布はありません</strong>。vol.1、vol.2は次の電子書籍をご利用ください。</p>

<ul>
<li><a href="https://gumroad.com/l/xgnF">urandom vol.1</a></li>
<li><a href="https://gumroad.com/l/zjTOY">urandom vol.2</a></li>
</ul>

<p>vol.3の電子書籍版はコミックマーケット91の1ヶ月後を目処に配信予定です。</p>

<p>それでは、大晦日に会場でお会いしましょう。</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">14 Nov 2016, 20:01</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="//blog.urandom.team/post/my-linux-kernel-on-nesclassic/" class="post-title">ファミコンミニで自前のLinuxカーネルを動かす手順</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">op</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Misc" href="//blog.urandom.team/categories/misc">Misc</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h1 id="はじめに">はじめに</h1>

<p>ファミコンミニ自体の権利表記画面や<a href="https://www.nintendo.co.jp/support/oss/">任天堂Webサイト</a>で配布されているOSSソースコードからも分かるように、ファミコンミニの中で動いているのはU-bootで起動されたLinuxです。なので、ファミコンミニを適切に初期化した上で、適切にビルドしたLinuxカーネルを流しこめば、ファミコンミニ上で自前のLinuxを動かせます。U-boot(GPLv2)とLinux(GPLv2)のソースコードを読解・ビルドして自前のLinuxを起動したので、手順を書きます。</p>

<p><blockquote class="twitter-tweet tw-align-center" data-lang="ja"><p lang="ja" dir="ltr">ファミコンミニで自前ビルドのLinux動いた (My Linux kernel on NES Classic) <a href="https://t.co/00EZZgMx7A">pic.twitter.com/00EZZgMx7A</a></p>&mdash; op (@6f70) <a href="https://twitter.com/6f70/status/797939754528444416">2016年11月13日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<h1 id="注意">注意</h1>

<p><strong>この記事の内容を実践すると、製品保証が無効になったり、故障に繋がる可能性があります。内容を理解できる人が自己責任で行って下さい。</strong></p>

<h1 id="事前準備">事前準備</h1>

<ul>
<li><p>sunxi-fel (<a href="http://linux-sunxi.org/Sunxi-tools">sunxi-tools</a>)</p></li>

<li><p>abootimg</p></li>

<li><p>ARMのコンパイル環境</p>

<ul>
<li>Ubuntu 12.04 + gcc-arm-linux-gnueabi でテストしています。</li>
</ul></li>

<li><p>ファミコンミニのシリアルコンソール</p>

<ul>
<li>参考: <a href="https://www.ns-koubou.com/blog/2016/11/11/nes_classic/">ニンテンドークラシックミニ ファミリーコンピュータの中身の話 - えぬえす工房</a></li>
<li>参考: <a href="http://linux-sunxi.org/Nintendo_NES_Classic_Edition">Nintendo NES Classic Edition - linux-sunxi.org</a></li>
</ul></li>

<li><p>ファミコンミニとホストPCのUSB接続</p></li>
</ul>

<h1 id="手順">手順</h1>

<ol>
<li><p>U-boot, 起動イメージの取得</p>

<ol>
<li><p>シリアルコンソールで <code>s</code> キーを押しながらファミコンミニを起動して、U-bootのシェルに入ります。</p></li>

<li><p>シリアルコンソールで以下のコマンドを実行して、内蔵フラッシュの先頭部分を読み出します。</p>

<pre><code>sunxi_flash phy_read 58000000 0 80
</code></pre>

<p>読み出し先アドレス0x58000000とセクタ数0x80は、適当な使ってなさそうな所と長さなので、必然性はありません。</p></li>

<li><p>シリアルコンソールで <code>fastboot_test</code> コマンドを実行して、FELモードに入ります。</p>

<p>fastbootと言いつつFELモードに入ります。このFELモードでは最初からDRAMが有効化されています。ただし、シリアルコンソールが壊れるようです。</p></li>

<li><p>ホストで以下のコマンドを実行して、手順1.2で読みだしたイメージをホストへ転送します。</p>

<pre><code>sunxi-fel read 0x58000000 0x1000000 0000-0080.bin
</code></pre></li>

<li><p>U-bootのマジック <code>uboot</code> でイメージ中を検索するとU-bootが見つかります。オフセット0x14にサイズが格納されているので、それを元に切り出します。切り出したファイルをu-boot.binとします。</p></li>

<li><p>起動イメージのマジック <code>ANDROID!</code> でイメージ中を検索すると起動イメージが見つかるので、適当に切り出します。切り出したファイルをboot.imgとします。</p></li>
</ol></li>

<li><p>Linuxのビルド</p>

<p>配布されているソースコード中の linux-9ed0e6c8612113834e9af9d16a3e90b573c488ca をビルドします。</p>

<ol>
<li><p><code>drivers/video/sunxi/hdmi_ep952/EP952api.h</code> のコメントアウトされている <code>WARN</code> マクロを有効にします。</p></li>

<li><p>以下のコマンドを実行してconfigします。</p>

<pre><code>export ARCH=arm
export CROSS_COMPILE=arm-linux-gnueabi-

make sun8iw5p1smp_defconfig
</code></pre></li>

<li><p>.configに以下の変更を加えます。</p>

<pre><code>CONFIG_INITRAMFS_SOURCE=&quot;&quot;
CONFIG_CMA=y
CONFIG_FB_SUNXI=y
CONFIG_CMDLINE_FORCE=n
CONFIG_USB_SUPPORT=n
</code></pre>

<p>USBを切っているのは単にサイズ削減の為です。</p></li>

<li><p>以下のコマンドを実行してビルドします。</p>

<pre><code>make zImage
</code></pre>

<p>対話的に聞かれるconfigの確認は全部そのままでもとりあえず動きました。</p></li>
</ol></li>

<li><p>U-boot, 起動イメージの作成</p>

<ol>
<li><p>u-boot.bin中の <code>bootcmd=sunxi_flash phy_read 43800000 30 20;boota 43800000</code> を <code>bootcmd=boota 43800000</code> に置換します(オフセットがずれないようにNULLパディング)。</p></li>

<li><p>以下のコマンドで起動イメージを展開します。</p>

<pre><code>abootimg -x boot.img
</code></pre></li>

<li><p>zImageを手順2で作成したものに差し替え、以下のコマンドで起動イメージを再作成します。</p>

<pre><code>abootimg --create myboot.img -f bootimg.cfg -k zImage -r initrd.img
</code></pre>

<p>このままではinitrd.imgを展開できないので、起動しても <code>/init</code> を実行できずにPanicします。
起動後にシェル等を操作したい場合は、カーネルパラメーターとinitrd.imgを適宜編集したり作りなおして下さい。</p></li>
</ol></li>

<li><p>Linuxの起動</p>

<ol>
<li><p>手順1.1, 1.3でFELモードに入ります。</p></li>

<li><p>ホストで以下のコマンドを実行すると、Linuxが起動します。</p>

<pre><code>sunxi-fel write 0x43800000 myboot.img
sunxi-fel write 0x47000000 u-boot.bin
sunxi-fel exe   0x47000000
</code></pre></li>
</ol></li>
</ol>

<h1 id="おわりに">おわりに</h1>

<p>ざっと手順を書き出しました。ファミコンミニは拡張性が低いのが難点ですが、計算能力はそれなりにあるので色々な事ができそうです。
Linuxカーネルはとりあえず動くものをビルドしたので、より適切なビルド方法は他にあるかと思いますし、起動手順ももっと簡素な物がありそうです。</p>

<p>作業を始めた当初は <code>fastboot_test</code> コマンドでDRAM有効化済みのFELモードに入れる事に気付いておらず、 <code>efex</code> コマンドでDRAM無効なFELモードに入って、頑張って自前でDRAMを有効化して作業していました。
その辺のU-bootの紆余曲折やソースコードを解説する記事を、C91で頒布する同人誌 <a href="//blog.urandom.team/post/c90-digital-and-c91/">urandom vol.3</a> に書く予定です（落とさなければ）。続報は追ってこのブログに書きます。</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">02 Nov 2016, 22:55</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="//blog.urandom.team/post/c90-digital-and-c91/" class="post-title">urandom vol.2電子版公開のお知らせとC91告知</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mayth</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Publication" href="//blog.urandom.team/categories/publication">Publication</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h1 id="urandom-vol-2電子版">urandom vol.2電子版</h1>

<p>大変長らくお待たせしました。urandom vol.2の電子版を公開しました。</p>

<p>urandom vol.2電子版は <strong>128円</strong> での販売となります。内容は物理書籍版とほぼ同じです（どこが違うか探してみよう！　特に景品はないです）。</p>

<p>販売ページは<a href="https://gumroad.com/l/zjTOY">こちら（Gumroad）</a>です。決済にはクレジットカードかPayPalが使えます。</p>

<h2 id="物理書籍版購入者の方へ">物理書籍版購入者の方へ</h2>

<p>購入ページに&rdquo;Offer code&rdquo;という欄がありますので、そちらに物理書籍挟み込みの紙に記載されたコードを入力してください。</p>

<ul>
<li>コードを使用する場合、クレジットカード情報は不要です。正しいコードを入力すると入力欄が非表示になります。</li>
<li>同一コードは10回まで使用可能です。ダウンロードしたデータを紛失した際は同一コードを入力してください。</li>
</ul>

<h1 id="urandom-vol-3">urandom vol.3</h1>

<p>続けて冬のお知らせです。無事に冬コミ（C91）に当選しました。スペースは <strong>土曜日 東R-12b</strong> です（<a href="https://webcatalog.circle.ms/Circle/13006119">Webカタログはこちら</a>）。</p>

<p>これまでだと「だいたいこういう内容になる予定ですよ」というリストくらいは出せていたのですが、今回は現時点で何も決まっておりません。
が、コンピュータセキュリティ的な本であるところからは変わりないと思います。内容が決まり次第随時告知しますので、今しばらくお待ちください。</p>

<p>それでは、今年も大晦日にお会いしましょう。</p>

                    </div>
                </section>
                
            </div>
            
<div class="pagination">
  <nav role="pagination" class="post-list-pagination">
      
    <span class="post-list-pagination-item post-list-pagination-item-current">Page 1 of 2</span>
    
      <a href="/post/page/2/" class="post-list-pagination-item pure-button post-list-pagination-item-next">
        Older&nbsp;<i class="fa fa-angle-double-right"></i>
      </a>
    
  </nav>
</div>


            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>Powered by <a class="hugo" href="http://hugo.spf13.com/" target="_blank">hugo</a></li>
        </ul>
    </div>
</div>
<script src="//blog.urandom.team/js/all.min.js"></script>
        </div>
    </div>
</div>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
